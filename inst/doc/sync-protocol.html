<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Synchronization Protocol</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Synchronization Protocol</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(automerge)</span></code></pre></div>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p>Automerge’s synchronization protocol enables multiple peers to
exchange changes and converge to the same document state. The protocol
is efficient, handling only missing changes between peers, and works
over any transport (files, HTTP, WebSockets, etc.).</p>
</div>
<div id="high-level-sync-recommended" class="section level2">
<h2>High-Level Sync (Recommended)</h2>
<p>For most use cases, use the high-level sync helpers that handle the
protocol automatically.</p>
<div id="bidirectional-sync" class="section level3">
<h3>Bidirectional Sync</h3>
<p>The simplest way to synchronize two documents:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Create two peers with different data</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>peer1 <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>peer1[[<span class="st">&quot;edited_by&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;peer1&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>peer1[[<span class="st">&quot;data1&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="fu">am_commit</span>(peer1, <span class="st">&quot;Peer1 changes&quot;</span>)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>peer2 <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>peer2[[<span class="st">&quot;edited_by&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;peer2&quot;</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>peer2[[<span class="st">&quot;data2&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="fu">am_commit</span>(peer2, <span class="st">&quot;Peer2 changes&quot;</span>)</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="co"># Automatic bidirectional sync (documents modified in place)</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>rounds <span class="ot">&lt;-</span> <span class="fu">am_sync</span>(peer1, peer2)</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>rounds</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="co">#&gt; [1] 4</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a><span class="co"># Both documents now have all data</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>peer1[[<span class="st">&quot;data1&quot;</span>]]</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a><span class="co">#&gt; [1] 100</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>peer1[[<span class="st">&quot;data2&quot;</span>]]</span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a><span class="co">#&gt; [1] 200</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>peer2[[<span class="st">&quot;data1&quot;</span>]]</span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a><span class="co">#&gt; [1] 100</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>peer2[[<span class="st">&quot;data2&quot;</span>]]</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a><span class="co">#&gt; [1] 200</span></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a><span class="fu">am_close</span>(peer1)</span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a><span class="fu">am_close</span>(peer2)</span></code></pre></div>
<p><strong>When to use</strong>: Simple peer-to-peer synchronization
where both sides need all changes.</p>
</div>
<div id="one-way-merge" class="section level3">
<h3>One-Way Merge</h3>
<p>For pulling changes from one document to another without sending
changes back:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Create source document</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>source <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>source[[<span class="st">&quot;version&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;2.0&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>source[[<span class="st">&quot;features&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;auth&quot;</span>, <span class="st">&quot;api&quot;</span>)</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="fu">am_commit</span>(source)</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co"># Create target document</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>target <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>target[[<span class="st">&quot;version&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;1.0&quot;</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>target[[<span class="st">&quot;development&quot;</span>]] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="fu">am_commit</span>(target)</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="co"># Pull changes from source to target</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a><span class="fu">am_merge</span>(target, source)</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="co"># Target now has source&#39;s changes</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>target[[<span class="st">&quot;version&quot;</span>]]</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1.0&quot;</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="co"># Source is unchanged</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="fu">names</span>(source)</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="co">#&gt; [1] &quot;features&quot; &quot;version&quot;</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a><span class="fu">am_close</span>(source)</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a><span class="fu">am_close</span>(target)</span></code></pre></div>
<p><strong>When to use</strong>: Client pulling updates from server,
importing changes from another peer.</p>
</div>
</div>
<div id="low-level-sync-protocol" class="section level2">
<h2>Low-Level Sync Protocol</h2>
<p>For network protocols or fine-grained control, use the low-level
API.</p>
<div id="basic-protocol-flow" class="section level3">
<h3>Basic Protocol Flow</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Create two peers</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>peer3 <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>peer3[[<span class="st">&quot;source&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;peer3&quot;</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="fu">am_commit</span>(peer3)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>peer4 <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>peer4[[<span class="st">&quot;source&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;peer4&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="fu">am_commit</span>(peer4)</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co"># Each peer maintains its own sync state</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>sync3 <span class="ot">&lt;-</span> <span class="fu">am_sync_state_new</span>()</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>sync4 <span class="ot">&lt;-</span> <span class="fu">am_sync_state_new</span>()</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="co"># Exchange messages until converged</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>round <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a><span class="cf">repeat</span> {</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>  round <span class="ot">&lt;-</span> round <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>  <span class="co"># Peer 3 generates message</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>  msg3 <span class="ot">&lt;-</span> <span class="fu">am_sync_encode</span>(peer3, sync3)</span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(msg3)) {</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>  } <span class="co"># No more messages</span></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>  <span class="co"># Peer 4 receives and processes</span></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>  <span class="fu">am_sync_decode</span>(peer4, sync4, msg3)</span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>  <span class="co"># Peer 4 generates response</span></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>  msg4 <span class="ot">&lt;-</span> <span class="fu">am_sync_encode</span>(peer4, sync4)</span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(msg4)) {</span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>  } <span class="co"># No more messages</span></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>  <span class="co"># Peer 3 receives and processes</span></span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>  <span class="fu">am_sync_decode</span>(peer3, sync3, msg4)</span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>  <span class="cf">if</span> (round <span class="sc">&gt;</span> <span class="dv">100</span>) {</span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">&quot;Sync did not converge in 100 rounds&quot;</span>)</span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>  }</span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a>}</span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a>round</span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a><span class="co">#&gt; [1] 3</span></span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a>peer3[[<span class="st">&quot;source&quot;</span>]]</span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a><span class="co">#&gt; [1] &quot;peer4&quot;</span></span>
<span id="cb4-47"><a href="#cb4-47" tabindex="-1"></a>peer4[[<span class="st">&quot;source&quot;</span>]]</span>
<span id="cb4-48"><a href="#cb4-48" tabindex="-1"></a><span class="co">#&gt; [1] &quot;peer4&quot;</span></span>
<span id="cb4-49"><a href="#cb4-49" tabindex="-1"></a></span>
<span id="cb4-50"><a href="#cb4-50" tabindex="-1"></a><span class="fu">am_close</span>(peer3)</span>
<span id="cb4-51"><a href="#cb4-51" tabindex="-1"></a><span class="fu">am_close</span>(peer4)</span></code></pre></div>
</div>
<div id="protocol-components" class="section level3">
<h3>Protocol Components</h3>
<p><strong>Sync State</strong> (<code>am_sync_state_new()</code>):</p>
<ul>
<li>Tracks what each peer knows</li>
<li>Document-independent (can be reused)</li>
<li>Should be preserved across sessions for efficiency</li>
</ul>
<p><strong>Sync Encode</strong>
(<code>am_sync_encode(doc, sync_state)</code>):</p>
<ul>
<li>Generates sync message to send to peer</li>
<li>Returns <code>NULL</code> when no more changes to send</li>
<li>Message is binary (raw vector)</li>
</ul>
<p><strong>Sync Decode</strong>
(<code>am_sync_decode(doc, sync_state, message)</code>):</p>
<ul>
<li>Receives sync message from peer</li>
<li>Updates document and sync state</li>
<li>Returns document invisibly for chaining</li>
</ul>
</div>
</div>
<div id="change-based-synchronization" class="section level2">
<h2>Change-Based Synchronization</h2>
<p>For scenarios where you want explicit control over individual
changes:</p>
<div id="exporting-and-importing-changes" class="section level3">
<h3>Exporting and Importing Changes</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Create base document that will be shared</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>base_doc <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>base_doc[[<span class="st">&quot;v1&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;first&quot;</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="fu">am_commit</span>(base_doc, <span class="st">&quot;Version 1&quot;</span>)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co"># Fork to create two peers with shared history</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>peer_a <span class="ot">&lt;-</span> <span class="fu">am_fork</span>(base_doc)</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>peer_b <span class="ot">&lt;-</span> <span class="fu">am_fork</span>(base_doc)</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co"># Remember the fork point</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>fork_heads <span class="ot">&lt;-</span> <span class="fu">am_get_heads</span>(peer_a)</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="co"># Peer A makes changes</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>peer_a[[<span class="st">&quot;v2&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;second&quot;</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a><span class="fu">am_commit</span>(peer_a, <span class="st">&quot;Version 2&quot;</span>)</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>peer_a[[<span class="st">&quot;v3&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;third&quot;</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="fu">am_commit</span>(peer_a, <span class="st">&quot;Version 3&quot;</span>)</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a><span class="co"># Export changes since fork point</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>changes <span class="ot">&lt;-</span> <span class="fu">am_get_changes</span>(peer_a, fork_heads)</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a><span class="fu">length</span>(changes)</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a><span class="co">#&gt; [1] 2</span></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a><span class="co"># Peer B applies the changes</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a><span class="fu">am_apply_changes</span>(peer_b, changes)</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a><span class="co"># Verify both peers are in sync</span></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>peer_b[[<span class="st">&quot;v2&quot;</span>]]</span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a><span class="co">#&gt; [1] &quot;second&quot;</span></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>peer_b[[<span class="st">&quot;v3&quot;</span>]]</span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a><span class="co">#&gt; [1] &quot;third&quot;</span></span></code></pre></div>
</div>
<div id="saving-changes-to-files" class="section level3">
<h3>Saving Changes to Files</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Save individual changes to files</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>temp_dir <span class="ot">&lt;-</span> <span class="fu">tempdir</span>()</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(changes)) {</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  change_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(temp_dir, <span class="fu">sprintf</span>(<span class="st">&quot;change_%03d.bin&quot;</span>, i))</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="fu">writeBin</span>(changes[[i]], change_file)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>}</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co"># Later: load and apply changes</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>loaded_changes <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(changes)) {</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>  change_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(temp_dir, <span class="fu">sprintf</span>(<span class="st">&quot;change_%03d.bin&quot;</span>, i))</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>  loaded_changes[[i]] <span class="ot">&lt;-</span> <span class="fu">readBin</span>(change_file, <span class="st">&quot;raw&quot;</span>, <span class="fu">file.size</span>(change_file))</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>}</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="co"># Apply loaded changes to a peer</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>peer_c <span class="ot">&lt;-</span> <span class="fu">am_fork</span>(base_doc)</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="fu">am_apply_changes</span>(peer_c, loaded_changes)</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a><span class="co"># Verify</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>peer_c[[<span class="st">&quot;v3&quot;</span>]]</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a><span class="co">#&gt; [1] &quot;third&quot;</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a><span class="fu">am_close</span>(base_doc)</span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a><span class="fu">am_close</span>(peer_a)</span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a><span class="fu">am_close</span>(peer_b)</span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a><span class="fu">am_close</span>(peer_c)</span></code></pre></div>
<p><strong>When to use</strong>: Git-like workflows, change logs,
selective sync.</p>
</div>
</div>
<div id="document-heads-and-history" class="section level2">
<h2>Document Heads and History</h2>
<div id="understanding-heads" class="section level3">
<h3>Understanding Heads</h3>
<p><strong>Heads</strong> are the most recent commits in a document’s
history. They represent the current state’s frontier in the change
graph.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Create document and make changes</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>doc_main <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>doc_main[[<span class="st">&quot;version&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;1.0&quot;</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="fu">am_commit</span>(doc_main, <span class="st">&quot;Initial version&quot;</span>)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="co"># Get heads (fingerprint of current state)</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>heads_v1 <span class="ot">&lt;-</span> <span class="fu">am_get_heads</span>(doc_main)</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="fu">length</span>(heads_v1)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="co"># Make more changes</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>doc_main[[<span class="st">&quot;version&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;2.0&quot;</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>doc_main[[<span class="st">&quot;feature&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;new&quot;</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="fu">am_commit</span>(doc_main, <span class="st">&quot;Version 2&quot;</span>)</span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>heads_v2 <span class="ot">&lt;-</span> <span class="fu">am_get_heads</span>(doc_main)</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="fu">identical</span>(heads_v1, heads_v2)</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>Heads are useful for:</p>
<ul>
<li>Tracking which changes you’ve already seen</li>
<li>Computing incremental updates</li>
<li>Detecting whether documents have diverged</li>
</ul>
</div>
<div id="working-with-history" class="section level3">
<h3>Working with History</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># Get full change history</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>history <span class="ot">&lt;-</span> <span class="fu">am_get_history</span>(doc_main)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="fu">length</span>(history)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co">#&gt; [1] 2</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="co"># History includes all commits ever made</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="co"># Each entry contains metadata about a commit</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="co"># Get changes between two points in history</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>changes_since_v1 <span class="ot">&lt;-</span> <span class="fu">am_get_changes</span>(doc_main, heads_v1)</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a><span class="fu">str</span>(changes_since_v1)</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="co">#&gt; List of 1</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a><span class="co">#&gt;  $ : raw [1:126] 85 6f 4a 83 ...</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="fu">am_close</span>(doc_main)</span></code></pre></div>
</div>
<div id="incremental-sync-pattern" class="section level3">
<h3>Incremental Sync Pattern</h3>
<p>Common pattern: track last sync point and only send new changes</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># Server document that accumulates changes</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>server[[<span class="st">&quot;users&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">0</span><span class="dt">L</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="fu">am_commit</span>(server, <span class="st">&quot;Initialize&quot;</span>)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co"># Client syncs and remembers server state</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>client <span class="ot">&lt;-</span> <span class="fu">am_fork</span>(server)</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>last_sync_heads <span class="ot">&lt;-</span> <span class="fu">am_get_heads</span>(server)</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="co"># Client makes local changes</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>client[[<span class="st">&quot;users&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="dt">L</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>client[[<span class="st">&quot;local_cache&quot;</span>]] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="fu">am_commit</span>(client, <span class="st">&quot;Client updates&quot;</span>)</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="co"># Server receives changes from other clients</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>server[[<span class="st">&quot;users&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">5</span><span class="dt">L</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>server[[<span class="st">&quot;server_config&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;production&quot;</span></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a><span class="fu">am_commit</span>(server, <span class="st">&quot;Server updates&quot;</span>)</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a><span class="co"># Client pulls only new server changes since last sync</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>new_changes <span class="ot">&lt;-</span> <span class="fu">am_get_changes</span>(server, last_sync_heads)</span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a><span class="fu">length</span>(new_changes)</span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a><span class="fu">am_apply_changes</span>(client, new_changes)</span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a><span class="co"># Update sync point</span></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>last_sync_heads <span class="ot">&lt;-</span> <span class="fu">am_get_heads</span>(server)</span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a><span class="co"># Client now has server&#39;s changes</span></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>client[[<span class="st">&quot;server_config&quot;</span>]]</span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a><span class="co">#&gt; [1] &quot;production&quot;</span></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a><span class="co"># Server can also pull client&#39;s changes</span></span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a>client_changes <span class="ot">&lt;-</span> <span class="fu">am_get_changes</span>(client, <span class="fu">am_get_heads</span>(server))</span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a><span class="fu">am_apply_changes</span>(server, client_changes)</span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a>server[[<span class="st">&quot;local_cache&quot;</span>]]</span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a><span class="fu">am_close</span>(server)</span>
<span id="cb9-42"><a href="#cb9-42" tabindex="-1"></a><span class="fu">am_close</span>(client)</span></code></pre></div>
</div>
<div id="detecting-divergence" class="section level3">
<h3>Detecting Divergence</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># Create two peers that will diverge</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>peer_x <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>peer_x[[<span class="st">&quot;id&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;x&quot;</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="fu">am_commit</span>(peer_x)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>peer_y <span class="ot">&lt;-</span> <span class="fu">am_fork</span>(peer_x)</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="co"># Remember common state</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>common_heads <span class="ot">&lt;-</span> <span class="fu">am_get_heads</span>(peer_x)</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="co"># Both make different changes</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>peer_x[[<span class="st">&quot;data_x&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;from X&quot;</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="fu">am_commit</span>(peer_x, <span class="st">&quot;X&#39;s change&quot;</span>)</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>peer_y[[<span class="st">&quot;data_y&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;from Y&quot;</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="fu">am_commit</span>(peer_y, <span class="st">&quot;Y&#39;s change&quot;</span>)</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="co"># Check if they&#39;ve diverged</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>x_heads <span class="ot">&lt;-</span> <span class="fu">am_get_heads</span>(peer_x)</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>y_heads <span class="ot">&lt;-</span> <span class="fu">am_get_heads</span>(peer_y)</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a><span class="fu">identical</span>(x_heads, y_heads)</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a><span class="co">#&gt; [1] FALSE</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a><span class="co"># Get each peer&#39;s changes since common state</span></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>x_changes <span class="ot">&lt;-</span> <span class="fu">am_get_changes</span>(peer_x, common_heads)</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>y_changes <span class="ot">&lt;-</span> <span class="fu">am_get_changes</span>(peer_y, common_heads)</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a><span class="fu">str</span>(x_changes)</span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a><span class="co">#&gt; List of 1</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a><span class="co">#&gt;  $ : raw [1:109] 85 6f 4a 83 ...</span></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a><span class="fu">str</span>(y_changes)</span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a><span class="co">#&gt; List of 1</span></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a><span class="co">#&gt;  $ : raw [1:109] 85 6f 4a 83 ...</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a><span class="co"># Sync to merge divergent histories</span></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a>rounds <span class="ot">&lt;-</span> <span class="fu">am_sync</span>(peer_x, peer_y)</span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a>rounds</span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a><span class="co">#&gt; [1] 4</span></span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a><span class="co"># After sync, heads are identical again</span></span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a><span class="fu">identical</span>(<span class="fu">am_get_heads</span>(peer_x), <span class="fu">am_get_heads</span>(peer_y))</span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a><span class="fu">am_close</span>(peer_x)</span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a><span class="fu">am_close</span>(peer_y)</span></code></pre></div>
</div>
</div>
<div id="concurrent-edits" class="section level2">
<h2>Concurrent Edits</h2>
<p>Understanding how concurrent edits merge:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># Create shared starting point</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>base <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>base[[<span class="st">&quot;counter&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">am_counter</span>(<span class="dv">0</span>)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>base[[<span class="st">&quot;status&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;draft&quot;</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="fu">am_commit</span>(base)</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="co"># Fork to two editors</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>editor1 <span class="ot">&lt;-</span> <span class="fu">am_fork</span>(base)</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>editor2 <span class="ot">&lt;-</span> <span class="fu">am_fork</span>(base)</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co"># Concurrent edits</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co"># Editor 1: increment counter, change status</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="fu">am_counter_increment</span>(editor1, AM_ROOT, <span class="st">&quot;counter&quot;</span>, <span class="dv">5</span>)</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>editor1[[<span class="st">&quot;status&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;review&quot;</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="fu">am_commit</span>(editor1, <span class="st">&quot;Editor 1 changes&quot;</span>)</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a><span class="co"># Editor 2: increment counter differently, change status differently</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a><span class="fu">am_counter_increment</span>(editor2, AM_ROOT, <span class="st">&quot;counter&quot;</span>, <span class="dv">3</span>)</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>editor2[[<span class="st">&quot;status&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;published&quot;</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a><span class="fu">am_commit</span>(editor2, <span class="st">&quot;Editor 2 changes&quot;</span>)</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a><span class="co"># Sync editors</span></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>rounds <span class="ot">&lt;-</span> <span class="fu">am_sync</span>(editor1, editor2)</span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a><span class="co"># Counter: Both increments sum (CRDT)</span></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>editor1[[<span class="st">&quot;counter&quot;</span>]]</span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a><span class="co">#&gt; &lt;Automerge Counter: 8 &gt;</span></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a><span class="co"># Status: Deterministic conflict resolution (one value wins)</span></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>editor1[[<span class="st">&quot;status&quot;</span>]]</span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a><span class="co">#&gt; [1] &quot;published&quot;</span></span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a><span class="fu">am_close</span>(base)</span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a><span class="fu">am_close</span>(editor1)</span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a><span class="fu">am_close</span>(editor2)</span></code></pre></div>
</div>
<div id="sync-performance" class="section level2">
<h2>Sync Performance</h2>
<div id="the-sync-frequency-tradeoff" class="section level3">
<h3>The Sync Frequency Tradeoff</h3>
<p>There’s a fundamental tradeoff between <em>collaboration latency</em>
and <em>efficiency</em>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># Strategy A: Frequent sync (lower latency, more overhead)</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>doc_frequent <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>peer_frequent <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>sync_count_frequent <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>  doc_frequent[[<span class="fu">paste0</span>(<span class="st">&quot;k&quot;</span>, i)]] <span class="ot">&lt;-</span> i</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>  <span class="fu">am_commit</span>(doc_frequent, <span class="fu">paste</span>(<span class="st">&quot;Change&quot;</span>, i))</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  rounds <span class="ot">&lt;-</span> <span class="fu">am_sync</span>(doc_frequent, peer_frequent)</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  sync_count_frequent <span class="ot">&lt;-</span> sync_count_frequent <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>}</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a><span class="co"># 10 separate commits, 10 sync operations</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>sync_count_frequent</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="co">#&gt; [1] 10</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a><span class="co"># Strategy B: Batched commits (higher latency, less overhead)</span></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>doc_batched <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>peer_batched <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a><span class="co"># Batch all changes into one commit</span></span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) {</span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>  doc_batched[[<span class="fu">paste0</span>(<span class="st">&quot;k&quot;</span>, i)]] <span class="ot">&lt;-</span> i</span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a>}</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a><span class="fu">am_commit</span>(doc_batched, <span class="st">&quot;Batch of 10 changes&quot;</span>)</span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a>rounds <span class="ot">&lt;-</span> <span class="fu">am_sync</span>(doc_batched, peer_batched)</span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a><span class="co"># 1 commit, 1 sync operation</span></span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a>rounds</span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a><span class="co">#&gt; [1] 4</span></span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a><span class="co"># Compare document sizes</span></span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">am_save</span>(doc_frequent))</span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a><span class="co">#&gt; [1] 265</span></span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">am_save</span>(doc_batched))</span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a><span class="co">#&gt; [1] 186</span></span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a><span class="fu">am_close</span>(doc_frequent)</span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a><span class="fu">am_close</span>(peer_frequent)</span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a><span class="fu">am_close</span>(doc_batched)</span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a><span class="fu">am_close</span>(peer_batched)</span></code></pre></div>
<p><strong>Batching creates smaller documents</strong> because:</p>
<ul>
<li>Fewer commit metadata entries</li>
<li>Better compression of related changes</li>
<li>Less overhead from commit boundaries</li>
</ul>
</div>
<div id="choosing-a-strategy" class="section level3">
<h3>Choosing a Strategy</h3>
<p><strong>Use frequent syncs when:</strong></p>
<ul>
<li>Multiple users editing simultaneously</li>
<li>Low-latency collaboration is critical (real-time editing)</li>
<li>Users need to see each other’s changes quickly</li>
<li>Working over reliable, fast networks</li>
</ul>
<p><strong>Use batched commits when:</strong></p>
<ul>
<li>Single user making many changes</li>
<li>Optimizing for storage/bandwidth</li>
<li>Syncing over slow or metered connections</li>
<li>Changes are logically related (e.g., form submission)</li>
</ul>
<p><strong>Hybrid approach</strong> (recommended for most cases):</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># Batch related changes, sync periodically</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>doc_hybrid <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co"># User fills out a form (batch these)</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>doc_hybrid[[<span class="st">&quot;name&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;Alice&quot;</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>doc_hybrid[[<span class="st">&quot;email&quot;</span>]] <span class="ot">&lt;-</span> <span class="st">&quot;alice@example.com&quot;</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>doc_hybrid[[<span class="st">&quot;preferences&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;theme&quot;</span> <span class="ot">=</span> <span class="st">&quot;dark&quot;</span>)</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="fu">am_commit</span>(doc_hybrid, <span class="st">&quot;Update user profile&quot;</span>)</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="co"># Sync after logical unit of work</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a><span class="co"># result &lt;- sync_with_server(doc_hybrid)</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a><span class="co"># Later: another logical unit</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>doc_hybrid[[<span class="st">&quot;last_login&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="fu">am_commit</span>(doc_hybrid, <span class="st">&quot;Record login&quot;</span>)</span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a><span class="co"># Sync again</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a><span class="co"># result &lt;- sync_with_server(doc_hybrid)</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a><span class="fu">am_close</span>(doc_hybrid)</span></code></pre></div>
</div>
<div id="reusing-sync-state" class="section level3">
<h3>Reusing Sync State</h3>
<p>Sync state tracks what each peer has seen, enabling efficient
incremental sync:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># Without reusing sync state (inefficient)</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>doc_no_reuse <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>doc_no_reuse[[<span class="st">&quot;v1&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="fu">am_commit</span>(doc_no_reuse)</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>peer_no_reuse <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="co"># First sync</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>rounds1 <span class="ot">&lt;-</span> <span class="fu">am_sync</span>(doc_no_reuse, peer_no_reuse)</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>rounds1</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="co">#&gt; [1] 4</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="co"># Add more changes</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>doc_no_reuse[[<span class="st">&quot;v2&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a><span class="fu">am_commit</span>(doc_no_reuse)</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a><span class="co"># Second sync (creates new sync state, may resend some data)</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>rounds2 <span class="ot">&lt;-</span> <span class="fu">am_sync</span>(doc_no_reuse, peer_no_reuse)</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>rounds2</span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a><span class="co">#&gt; [1] 4</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a><span class="co"># With reusing sync state (efficient)</span></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>doc_reuse <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>doc_reuse[[<span class="st">&quot;v1&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a><span class="fu">am_commit</span>(doc_reuse)</span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a>peer_reuse <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a>sync_state_local <span class="ot">&lt;-</span> <span class="fu">am_sync_state_new</span>()</span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a>sync_state_peer <span class="ot">&lt;-</span> <span class="fu">am_sync_state_new</span>()</span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a><span class="co"># Manual sync with persistent state</span></span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a>msg1 <span class="ot">&lt;-</span> <span class="fu">am_sync_encode</span>(doc_reuse, sync_state_local)</span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a><span class="fu">am_sync_decode</span>(peer_reuse, sync_state_peer, msg1)</span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a>msg2 <span class="ot">&lt;-</span> <span class="fu">am_sync_encode</span>(peer_reuse, sync_state_peer)</span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(msg2)) {</span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a>  <span class="fu">am_sync_decode</span>(doc_reuse, sync_state_local, msg2)</span>
<span id="cb14-38"><a href="#cb14-38" tabindex="-1"></a>}</span>
<span id="cb14-39"><a href="#cb14-39" tabindex="-1"></a></span>
<span id="cb14-40"><a href="#cb14-40" tabindex="-1"></a><span class="co"># Add more changes</span></span>
<span id="cb14-41"><a href="#cb14-41" tabindex="-1"></a>doc_reuse[[<span class="st">&quot;v2&quot;</span>]] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb14-42"><a href="#cb14-42" tabindex="-1"></a><span class="fu">am_commit</span>(doc_reuse)</span>
<span id="cb14-43"><a href="#cb14-43" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" tabindex="-1"></a><span class="co"># Second sync reuses state (only sends new changes)</span></span>
<span id="cb14-45"><a href="#cb14-45" tabindex="-1"></a>msg3 <span class="ot">&lt;-</span> <span class="fu">am_sync_encode</span>(doc_reuse, sync_state_local)</span>
<span id="cb14-46"><a href="#cb14-46" tabindex="-1"></a><span class="fu">am_sync_decode</span>(peer_reuse, sync_state_peer, msg3)</span>
<span id="cb14-47"><a href="#cb14-47" tabindex="-1"></a></span>
<span id="cb14-48"><a href="#cb14-48" tabindex="-1"></a><span class="co"># Sync state remembers what was already exchanged</span></span>
<span id="cb14-49"><a href="#cb14-49" tabindex="-1"></a></span>
<span id="cb14-50"><a href="#cb14-50" tabindex="-1"></a><span class="fu">am_close</span>(doc_no_reuse)</span>
<span id="cb14-51"><a href="#cb14-51" tabindex="-1"></a><span class="fu">am_close</span>(peer_no_reuse)</span>
<span id="cb14-52"><a href="#cb14-52" tabindex="-1"></a><span class="fu">am_close</span>(doc_reuse)</span>
<span id="cb14-53"><a href="#cb14-53" tabindex="-1"></a><span class="fu">am_close</span>(peer_reuse)</span></code></pre></div>
<p><strong>When to persist sync state:</strong></p>
<ul>
<li>Long-lived connections (WebSocket servers)</li>
<li>Periodic sync jobs (cron, scheduled tasks)</li>
<li>Client apps that reconnect frequently</li>
<li>Reduces redundant data transfer significantly</li>
</ul>
</div>
<div id="measuring-performance" class="section level3">
<h3>Measuring Performance</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># Compare efficiency of different approaches</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>measure_sync <span class="ot">&lt;-</span> <span class="cf">function</span>(n_changes, batch_size) {</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  doc <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  peer <span class="ot">&lt;-</span> <span class="fu">am_create</span>()</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  changes_made <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>  syncs_performed <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(n_changes)) {</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>    doc[[<span class="fu">paste0</span>(<span class="st">&quot;k&quot;</span>, i)]] <span class="ot">&lt;-</span> i</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>    changes_made <span class="ot">&lt;-</span> changes_made <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    <span class="co"># Commit every batch_size changes</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>    <span class="cf">if</span> (changes_made <span class="sc">%%</span> batch_size <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>      <span class="fu">am_commit</span>(doc, <span class="fu">sprintf</span>(<span class="st">&quot;Batch at %d&quot;</span>, changes_made))</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>      rounds <span class="ot">&lt;-</span> <span class="fu">am_sync</span>(doc, peer)</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>      syncs_performed <span class="ot">&lt;-</span> syncs_performed <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>    }</span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>  }</span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a>  <span class="co"># Final commit if needed</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>  <span class="cf">if</span> (changes_made <span class="sc">%%</span> batch_size <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a>    <span class="fu">am_commit</span>(doc, <span class="st">&quot;Final batch&quot;</span>)</span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a>    rounds <span class="ot">&lt;-</span> <span class="fu">am_sync</span>(doc, peer)</span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a>    syncs_performed <span class="ot">&lt;-</span> syncs_performed <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a>  }</span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a>    <span class="at">changes =</span> changes_made,</span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a>    <span class="at">syncs =</span> syncs_performed,</span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a>    <span class="at">size =</span> <span class="fu">length</span>(<span class="fu">am_save</span>(doc))</span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a>  )</span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a>  <span class="fu">am_close</span>(doc)</span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a>  <span class="fu">am_close</span>(peer)</span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a></span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a>  result</span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a>}</span>
<span id="cb15-39"><a href="#cb15-39" tabindex="-1"></a></span>
<span id="cb15-40"><a href="#cb15-40" tabindex="-1"></a><span class="co"># No batching: commit and sync after every change</span></span>
<span id="cb15-41"><a href="#cb15-41" tabindex="-1"></a>result_no_batch <span class="ot">&lt;-</span> <span class="fu">measure_sync</span>(<span class="dv">20</span>, <span class="dv">1</span>)</span>
<span id="cb15-42"><a href="#cb15-42" tabindex="-1"></a></span>
<span id="cb15-43"><a href="#cb15-43" tabindex="-1"></a><span class="co"># Medium batching: commit every 5 changes</span></span>
<span id="cb15-44"><a href="#cb15-44" tabindex="-1"></a>result_medium <span class="ot">&lt;-</span> <span class="fu">measure_sync</span>(<span class="dv">20</span>, <span class="dv">5</span>)</span>
<span id="cb15-45"><a href="#cb15-45" tabindex="-1"></a></span>
<span id="cb15-46"><a href="#cb15-46" tabindex="-1"></a><span class="co"># Full batching: single commit at end</span></span>
<span id="cb15-47"><a href="#cb15-47" tabindex="-1"></a>result_full <span class="ot">&lt;-</span> <span class="fu">measure_sync</span>(<span class="dv">20</span>, <span class="dv">20</span>)</span>
<span id="cb15-48"><a href="#cb15-48" tabindex="-1"></a></span>
<span id="cb15-49"><a href="#cb15-49" tabindex="-1"></a><span class="co"># Compare results</span></span>
<span id="cb15-50"><a href="#cb15-50" tabindex="-1"></a>result_no_batch<span class="sc">$</span>syncs</span>
<span id="cb15-51"><a href="#cb15-51" tabindex="-1"></a><span class="co">#&gt; [1] 20</span></span>
<span id="cb15-52"><a href="#cb15-52" tabindex="-1"></a>result_medium<span class="sc">$</span>syncs</span>
<span id="cb15-53"><a href="#cb15-53" tabindex="-1"></a><span class="co">#&gt; [1] 4</span></span>
<span id="cb15-54"><a href="#cb15-54" tabindex="-1"></a>result_full<span class="sc">$</span>syncs</span>
<span id="cb15-55"><a href="#cb15-55" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb15-56"><a href="#cb15-56" tabindex="-1"></a></span>
<span id="cb15-57"><a href="#cb15-57" tabindex="-1"></a><span class="co"># Document sizes</span></span>
<span id="cb15-58"><a href="#cb15-58" tabindex="-1"></a>result_no_batch<span class="sc">$</span>size</span>
<span id="cb15-59"><a href="#cb15-59" tabindex="-1"></a><span class="co">#&gt; [1] 461</span></span>
<span id="cb15-60"><a href="#cb15-60" tabindex="-1"></a>result_medium<span class="sc">$</span>size</span>
<span id="cb15-61"><a href="#cb15-61" tabindex="-1"></a><span class="co">#&gt; [1] 276</span></span>
<span id="cb15-62"><a href="#cb15-62" tabindex="-1"></a>result_full<span class="sc">$</span>size</span>
<span id="cb15-63"><a href="#cb15-63" tabindex="-1"></a><span class="co">#&gt; [1] 233</span></span></code></pre></div>
</div>
</div>
<div id="next-steps" class="section level2">
<h2>Next Steps</h2>
<ul>
<li>Learn about <a href="crdt-concepts.html">CRDT Concepts</a> to
understand merge behavior</li>
<li>Check the <a href="quick-reference.html">Quick Reference</a> for all
sync functions</li>
</ul>
</div>
<div id="further-reading" class="section level2">
<h2>Further Reading</h2>
<ul>
<li><a href="https://www.inkandswitch.com/local-first/">Local-First
Software</a></li>
</ul>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
